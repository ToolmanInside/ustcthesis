% !TeX root = ../main.tex

\chapter{序言}

\section{课题研究意义及国内外现状分析}

\subsection{研究意义}
自2009年“中本聪”发布了比特币的第一篇论文以来，区块链技术受到了越来越多的关注。虽然相比传统的计算机技术，区块链技术还比较年轻，但是区块链技术本身带来的新型货币体系，包括其在各行各业的应用：去中心化的新型银行\cite{blockchain-application}，基于去中心化智能合约的新型能源管理系统\cite{blockchain-in-energy}等等，无不凸显这一崭新技术在各行各业带来的革命性意义。

相比传统的中心化服务器，区块链技术的核心为去中心化的服务器系统，即网络中的每个运行区块链软件的设备都是一个独立的对等节点\cite{区块链技术及其应用研究}。相比传统的中心化服务器系统，区块链的网络中的所有节点在进行交易时不依赖于中间人，所有人都维护着同一个“账本”，并通过密码学算法对自己的交易信息进行签名加密，最后通过计算量证明来保证账本的有效和可靠性。区块链技术中体现出的去中心化，独立平等和无法随意篡改等等特性吸引了大量学者、企业、研究单位的关注。

在区块链的所有应用中，以太坊（Ethereum）是最火热的应用之一。以太坊是一个基于区块链技术的平台，发起的初衷为“建立无法被停止的应用”\cite{eth-intro}。他使用以太币（Ether）作为平台的主要货币，用密码学的算法来保证交易的正常进行。以太坊使用智能合约作为交易的主要媒介，网络中的各个节点通过智能合约完成交易、互动等功能。从2017年开始，以太坊的交易量开始高速增长\cite{eth-chart}，越来越多的用户开始使用智能合约完成以太币的交易，区块链游戏的交互等等任务。

智能合约是由一种图灵完整的编程语言，Solidity，编写而成的。随着使用智能合约的人越来越多，保证智能合约使用安全的呼声也越来越高，很多学者和研究机构开始注意这门新语言，并用软件分析的方法（静态、动态分析等等）去研究这门新语言。2016年9月，一场被称为“DAO攻击”的事件窃取了价值数百万美元的以太币\cite{dao-attack}。保证以太坊软件的安全迫在眉睫。

软件分析方法，包括静态分析、动态分析、形式验证、模糊测试、代码克隆检测等等方法，是保证软件安全、分析软件特性的必经之路。以上提到的几种分析方法，各有特点，应根据使用场景进行考虑，选取合适的分析方法。其中，静态分析主要以分析软件的抽象语法树（AST），控制流图（CFG）等作为主要的分析对象，辅以特征提取\cite{deckard}、图匹配等方法，分析软件的特点；动态分析主要侧重于使用符号执行、约束求解等等方法，分析软件的特点，相比静态分析耗时更长，但准确度更高；形式验证能保证较高的软件安全等级，主要侧重于对软件流程形式化描述的分析；模糊测试的特点在于通过种子（SEED）来制作测试用例生成器，对软件的攻击面（可能存在漏洞或者缺陷的地方）输入测试用例，通过对测试用例的不断变化来达到测试软件漏洞的目的；代码克隆借助LCS（最长公共子串）算法，分析执行迹线，仿真等等方法来分析代码的相似程度。

同时，我们在从Ehterscan爬取了200万个的智能合约之后，分析统计发现，只有不到10\%的智能合约是经过验证（能找到对应源代码）的，其余智能合约以字节码（Bytecode）的形式存在于以太坊的平台上。而传统的分析方法主要以白盒分析为主，面对字节码无能为力。而这部分合约又恰好牵扯了大量的以太坊资金，如果这部分以字节码形式存在的合约的安全不能得到保证，不仅易使以太坊的用户遭受大量的经济损失，扰乱区块链的经济秩序，也会带来更多的社会不安定因素。因此，我们需要一个能直接对字节码进行分析的系统来保证这部分软件的安全。

\subsection{国内外现状分析}

\subsubsection{智能合约漏洞国内外研究现状}

从2016年开始，越来越多的学者加入对智能合约的研究。出现了很多优秀的整理智能合约上容易出现的漏洞的工作，比如\cite{survey-on-attacks}，不仅收集了很有名的可重入漏洞，也有诸如错误乱序这种较难发现的漏洞，文中对各个漏洞也附上了代码示例。这些示例显然不是真实的例子，是作者自己根据漏洞的原理自己构造的，但浅显易懂，为刚开始接触智能合约的研究者提供了详实的资料。也有的团队\cite{survey-on-smart-contracts}，从分析以太坊的使用记录入手，根据他们的数据，目前大部分的智能合约都来交易以太币或者管理钱包，极少部分智能合约被用来进行游戏的交互和其他应用，这也说明大部分的智能合约是和经济安全紧密联系起来的。如果智能合约的安全受到侵害，会造成大量的经济损失，这更说明我们在智能合约的基础上研究软件安全是十分有必要的。

\subsubsection{软件分析方法国内外现状}

目前，国内外已有大量的软件分析方法的工作。静态的分析方法通过抽象语法树（AST），控制流图（CFG），程序依赖图（PDG）等分析程序的特点。动态分析方法比如\cite{survey-dynamic}就总结了目前流行的动态分析方法，动态分析方法具有精确度高的优点，但是覆盖率和耗时长也是在使用动态方法的时候不得不考虑的问题。但更多的工作是把静态分析和动态分析结合起来，既弥补了动态分析在覆盖率上的不足，也部分解决了静态分析准确度不高的问题。

由于智能合约还属于新事物，在智能合约上的软件分析方法还以静态分析和动态分析为主，当然也有使用形式验证、模糊测试等方法分析智能合约的。静态方法包括\textsc{Slither}\cite{slither}，是通过分析Solidity编译器生成AST，再将AST转换成IR（中间语言）和CFG（控制流图）；动态方法包括\textsc{Oyente}\cite{oyente}、\textsc{Securify}\cite{securify}、\textsc{Manticore}\cite{manticore}都是使用了约束求解的方法分析程序的CFG，然后根据约束求解的结果来分析软件的特点，其中\textsc{Oyente}和\textsc{Manticore}均使用了在软件分析领域小有名气的约束求解器Z3\cite{z3}，而\textsc{Securify}则使用的是\textsc{Souffle}\cite{souffle}进行约束求解。同样的，IBM的以太坊研究团队提出了\textsc{Zeus}\cite{zeus}，使用了形式验证的方法实现了对Solidity软件的分析。而\textsc{Echidna}\cite{echidna}，则是目前智能合约软件唯一的自动化模糊测试工具。智能合约虽然出生不久，但是分析智能合约的软件已经百花齐放。

\subsubsection{字节码分析方法国内外发展现状}

目前，Solidity语言的编译和执行都是通过EVM（以太坊虚拟机）进行的，相比在X86平台的C编译器生成的二进制文件，字节码是智能合约软件的最底层实现，直接在EVM上执行。想要分析字节码，最开始的一步就是要将字节码反编译过来。但是，彻底的反编译几乎是不可能的，Xiaozhu Meng的工作\cite{binary-not-ez}说明了在逆向工程中可能会遇到的问题，比如变量名无法复原、无法完全复原语义等等，其他的逆向工程的工作比如\textsc{DIVINE}\cite{divine}和\textsc{TIE}\cite{tie}研究了在逆向工程中复原变量名和复原变量原类型的可能性，但效果始终不太令人满意。近几年在智能合约上也有一些工作提供了很有创新的操作，比如\textsc{Erays}\cite{erays}，他们提出了将字节码转换成单赋值语句（SSA），在通过特殊的聚合手段加强SSA的语义信息，得到非常接近源代码的中间语言；而\textsc{Securify}\cite{securify}，则直接将字节码分析为控制流图，再在控制流图上分析操作的执行序列来寻找软件的漏洞。在智能合约领域已经出现了很多不错的分析字节码的工具，但不可否认的是，他们都有着明显的缺陷，比如\textsc{Erays}没有办法对复杂的语义进行整合，而\textsc{Securify}在大规模数据集上的表现很糟，可扩展性较差。为了解决这样的问题，我们提出用软件克隆分析的方法来分析智能合约代码。

\subsubsection{软件克隆分析方法国内外发展现状}
提到软件克隆分析就不得不提到ChanChal等人的工作\cite{survey-on-clone}，这篇文章分析了软件克隆分析法的优势和局限性，指出了克隆的四种级别，也推荐了一些克隆的分析方法。虽然这篇工作推荐的分析方法有部分已经落后于时代，但其中对克隆级别和克隆关键问题的讨论令人印象深刻。大体来说，各家对于什么是克隆、克隆的准确定义争论已久。同时，文中也支出了克隆的四种级别，第一类克隆、第二类克隆、第三类克隆和第四类克隆。其中，第一类克隆也叫完全克隆，两段代码只有空格和注释的不同。第二类克隆包括重命名克隆，即两段代码对变量的命名有差异。第三类克隆包括代码执行顺序，代码间隔的不同。而第四类克隆是语义上的相似，两段代码可以结构完全不同，但是功能是完全相同的。在这四种克隆类型中，第一类到第二类克隆因为比较简单，可以借助字符串匹配完美的实现，第三类克隆需要借助一些克隆分析手段，如最长公共子串（LCS）来实现，而第四类克隆需要我们加入更多的语义分析才能实现，是目前克隆的难点之一。

在针对二进制程序的克隆检测中，有工作比如\textsc{DECKARD}\cite{deckard}，通过分析编译器生成的AST，从AST中的关键节点提取关键信息，并将提取的信息扁平化，再比较特征向量在高维空间中的距离来分析两个软件代码的相似度；有工作\textsc{BinGo}\cite{bingo}采用了多样的分析方法，通过仿真，函数的执行路径，控制流图等方式来分析两个软件代码的相似度。

软件克隆有不得不面临的困难，可以也有得天独厚的优势。软件克隆方法在保证了一定的准确性的前提下，有着较好的可扩展性，在面对大量数据集的时候也能保证一定的的分析速度。本文的系统将把静态分析同克隆的方法结合起来，实现在字节码上的的软件分析。

\section{选题的先进性和实用性}

本系统是针对智能合约的字节码开发的软件分析系统。目前，世界上还没有一个完备的系统能够用软件克隆的方法实现对字节码的软件分析工作，因此，这不仅是创新的工作，也是有很大贡献的工作。同时，在以太坊上有大量的智能合约是以字节码的形式存在，这些合约和以太坊的经济安全息息相关，保证这部分智能合约的软件安全是很有价值的工作。
\textcolor{red}{add more, to 10 pages}

\section{选题的技术难度和工作量}

该选题技术难度适偏难，主要的难点在于以下几点：如何总结现有的漏洞主要攻击模式、如何高效地将字节码中的语义归纳、如何将克隆的方法同静态分析的方法结合起来，选题能满足研究生论文的研究要求；工作量主要体现在漏洞的主要供给模式上，需要阅读大量的漏洞代码，并且克隆方法的开发也需要大量的工作，但能够在预定的时间内完成课题研究的内容。
\textcolor{red}{add more, to 10 pages}

\section{主要研究内容}

\subsection{调研主要的几种Solidity漏洞}

智能合约和以太坊的经济安全息息相关，因此有不少不法分子妄图借助智能合约的软件漏洞，窃取钱财。为了更好的完成软件分析技术的开发工作，首先要做的就是充分调研目前现有的智能合约漏洞，这样不仅能更清楚地分析出黑客利用漏洞的攻击模式，也能细微地调整软件分析技术在不同漏洞上的表现。

\subsection{调研现有智能合约分析工具}

随着以太坊和智能合约的逐渐火热，有越来越多的团队加入智能合约的分析工作之中，有的团队提出分析技术，而更多的团队则是在原来的分析方法上做出针对智能合约改进。其中，有的团队使用了静态分析技术，如Slither、SmartCheck和Securify等等；有的团队使用了动态分析技术，如\textsc{Oyente}、\textsc{Mythril}、\textsc{MythX}、\textsc{Manticore}等等；有的团队使用了形式验证的技术，如Zeus；也有的团队使用了模糊测试的技术，如Echidna等等。为了提出一个经得起考验的标准数据集，广泛调研目前各家的技术是非常有必要的。

\subsection{调研现有智能合约字节码反编译技术}

反编译，特别是字节码的反编译，并不容易。首先，智能合约还尚属新事物，各类工具还不齐全，分析能力很有限；其次，以太坊虚拟机的特性也给反汇编技术的开发工作带来了困难。为了更好地开发出字节码反编译技术，我们需要对字节码的产生过程、字节码的特点、字节码的主要结构、操作码到字节码的映射关系等等有充分的了解。

\subsection{软件克隆分析技术在字节码上的应用}

软件克隆分析技术并不是第一次用在字节码的分析上。数年前在Java语言上就有很多相关工作实现了软件克隆分析技术与静态分析技术的结合，比如Sebyte在Java上通过提取原函数的相关信息（函数调用、变量类型等等）生成函数的“指纹”，在比对各个函数的指纹差异。EVM的字节码相比JVM，能提供的信息更少，也对我们的提出了挑战。同时，如果静态分析技术不能很好地与克隆分析技术结合或者结合的效果不好，我们也要考虑加入一些动态的分析技术，比如生成测试用例进行测试等等。


\section{拟解决的关键问题}

\subsection{标准数据集是否足够公平公正}

智能合约发展至今，还没有一个团队或者企业提出这样的一个标准数据集。我们从互联网上搜集合约代码数据，根据之前出现过的合约漏洞进行人工统计和分析。但即使是人工查验，也有误判和漏判的情况出现，这样我们的标准数据集是否足够标准将会成为一个值得讨论的问题。

\subsection{反编译技术是否能很好地捕捉语义，为克隆技术做好准备}

智能合约上的字节码反编译技术是我们这个研究项目的重点。如何通过反编译技术捕捉语义，可借鉴于之前在Java和Android上的一些工作。即便这样，我们也不得不面临着EVM字节码自带的难题：相比Java的字节码，EVM的字节码提供的信息更少。反编译技术的研发成功与否，直接影响了我们下一步将克隆技术的应用。

\subsection{克隆技术的应用效果是否符合预期}

在完成EVM字节码的反编译工作之后，我们需要实现软件克隆技术的应用。以往的软件克隆分析技术，包括提取操作序列、提取函数特征等等，在智能合约的中间语言上是否有效，我们要打一个问号。如果单一的技术行不通，那我们可以考虑加入其他静态分析技术或者动态分析技术，不断调整和优化软件分析系统